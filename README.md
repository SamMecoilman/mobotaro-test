# AI INSTRUCTIONS / SOURCE OF TRUTH

この README.md は本プロジェクトにおける **唯一の正本**。
AI（ChatGPT / Codex CLI）は必ず本ファイルを最初に読み、
以下の構造を厳密に解釈すること。

- **CANONICAL SPEC**：現在有効な憲法（最優先）
- **CURRENT STATE**：いま何を作っているか
- **DECISION LOG**：過去の判断ログ（消さない・巻き戻さない）

---

# CANONICAL SPEC（現在有効な仕様・憲法）

## 基本方針
- **PvEオンリー**
- **同時接続100人以上を前提に設計**
- 参考構造：**Realm of the Mad God Exalt 型**
  - 同一ワールドに多数のプレイヤーが存在
  - 高負荷戦闘は小規模インスタンスに分離
- プラットフォーム：**Web（PWA想定）**
- 世界観：**学園バトル**

---

## 戦闘の核：Survivor Battle Area
- 人数：**最大50人協力（PvE）**
- セッション時間：**5〜10分**
- 操作：**移動 + 攻撃（手動）**
- 敵：**大量スポーン**
- 難易度：**時間経過で上昇**
- 成長：**レベルアップ時にランダム強化**
- 当たり判定：**2D**
- 処理：**サーバ権威（authoritative）**
- Tick：**15〜20/s**

※ 初期フェーズでは「最小戦闘ループ（敵を倒せる）」の成立を最優先とする。

---

## 戦闘仕様（COMBAT）

- 攻撃は **手動発動**（オート攻撃は行わない）
- 攻撃は **射撃型（波動拳風）**
- 攻撃方向は以下のルールに従う：
  - 移動入力がある場合：その移動方向
  - 移動していない場合：最後に移動していた方向
- 射程は **「主人公2人分の距離」** を基準とする
- 敵へのダメージ判定・死亡判定は **サーバ側で確定**
- クライアントは攻撃演出（エフェクト）を表示するのみ

---

## 世界・ビジュアル
- 舞台：放課後の校舎／廊下／教室／体育館
- 背景：**HD-2D（3Dジオラマ）**
- キャラ／敵／弾：**ドット絵2D**
- ゲームロジック・当たり判定：**完全2D**
- 視認性最優先
  - 戦闘中 DOF 無効
  - 背景は低彩度

---

## UI / UX 方針（重要）

- ゲームプレイ領域は **画面中央** に集中させる
- UIは **画面の外縁（左右・下）に固定配置**する
- UIはカメラの影響を受けない（画面固定）

### UIの役割分担
- **左側 UI**
  - HP / SP 等のステータス
  - 操作ガイド（常時表示・簡潔）
- **右側 UI**
  - インベントリ等の所持・管理情報
- **下部 UI**
  - アイテムスロット（5）
  - スキルスロット（3）
  - 所持金表示

※ 初見プレイヤーが説明なしでも操作を理解できることを最優先とする。

---

## 入力方式（INPUT）

- 操作入力は共通の **MoveInput（x, y: -1.0〜1.0）** に統一
- クライアント側で各入力方式を MoveInput に変換し、サーバへ送信
- サーバは MoveInput のみを信頼して処理（入力方式非依存）

### 対応入力
- **PC**
  - 移動：WASD / 矢印キー
  - 攻撃：Spaceキー
  - タッチPC（2-in-1）もPCとして扱う

- **モバイル（スマホ／タブレット）**
  - 移動：仮想スティック（左下・移動のみ）
    - PCでは非表示
    - スマホ／タブレットでは表示
  - 攻撃：画面上の攻撃ボタン（右下）
  - iPad＋マウス等はタブレット判定とする

---

## AI運用ルール
- ChatGPT：設計・判断・Codex用プロンプト生成
- Codex CLI：リポジトリを直接編集して実装
- 人間：最終判断、commit / push のみ実行
- **不要な新規ファイル乱立は禁止**
- **既存コードは信用しないが削除しない**
- 迷ったら **最もシンプルな実装**を選ぶ

---

## 技術スタック（確定・最優先）

### クライアント
- 言語：**TypeScript**
- フレームワーク：**Phaser（2D）**
- 描画・当たり判定・入力はクライアント側で実装
- 2Dロジック前提（3Dは使用しない）

### マルチプレイ / ルーム管理
- **Colyseus**
  - WebSocket 通信
  - ルームベース
  - Survivor Battle Area は Colyseus Room として実装する

### サーバ
- **Node.js + TypeScript**
- フレームワーク：**Fastify または NestJS**
- Colyseus Server を内包
- ゲーム進行・同期・検証はサーバ権威（authoritative）

### データベース
- **PostgreSQL**
- ORM：**Prisma**
- ユーザー・進行状況・実績などを管理

### 認証
- **Discord OAuth2**
- Discord User ID を主キーとして扱う
- ゲーム内プレイヤーIDと1対1で紐付ける

### リアルタイム補助
- **Redis**
  - ルーム一覧キャッシュ
  - レート制限
  - ランキング・一時データのキャッシュ用途

### ホスティング / インフラ
- フロントエンド：**Cloudflare**
- サーバ：**Docker**
  - Fly.io / Render / 自前 VPS などを想定

---

<!-- AUTO:CURRENT_STATE:BEGIN -->
# CURRENT STATE（いまの作業位置）

- ブランチ：reboot
- フェーズ：土台構築（完了）→ 入力統一（完了）
- 到達点：
  - TypeScript + Phaser（client）起動（Vite）
  - TypeScript + Colyseus（server）起動（Fastify + ws-transport）
  - client ↔ server 接続
  - サーバtick稼働（15/s）
  - 敵スポーン（仮：1.5s間隔）
  - MoveInput（x,y:-1..1）へ入力を統一（WASD/矢印 + 仮想スティック）
  - 仮想スティックUI実装（左下）
  - カメラ追従（主人公中心）＋背景スクロール＋UI固定
  - 背景画像を map/school.png に差し替え、カメラ境界を画像サイズに合わせた
  - サーバ側でプレイヤー位置のクランプ範囲を画像サイズに合わせ調整
- ローカル起動：
  - npm install
  - npm run dev
  - http://localhost:5173
  - （任意）http://localhost:2567/health
- 既知の課題：
  - 背景画像サイズ変更時のクランプ範囲・カメラ境界・描画整合
  - 端末判定（スマホ / タブレット / PC）がUA依存でブレる可能性
- 次の目標（直近）：
  - 手動攻撃（PC / モバイル）で敵を倒せる最小戦闘ループの完成
  - 操作ガイド・攻撃ボタンを含むUIの確定
- 次の目標（中期）：
  - state同期を描画に統一（player/enemyをstate駆動）
  - Survivor戦闘の最小ループ完成
  - LvUP→強化選択→効果適用（最小実装）
<!-- AUTO:CURRENT_STATE:END -->

---

# DECISION LOG（過去の判断・消さない）

## 2026-01-13
- 既存コードは開発途中のため **ロジックとしては信用しない**
- ただし、リポジトリ・履歴・設定・文脈は再利用する
- 「全部削除して0から」はやらず、**骨格を使って再出発**する

## 2026-01-13
- PvPvE 案を廃止し、**PvE オンリー**に決定
- 同時接続100人は「同一ワールド＋分離インスタンス」で実現する
- Copilot は使用せず、**ChatGPT + Codex CLI** に統一
- README.md を **AI 指示の唯一の正本**とする
