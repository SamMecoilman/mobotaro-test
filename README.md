# AI INSTRUCTIONS / SOURCE OF TRUTH

この README.md は本プロジェクトにおける **唯一の正本**。
AI（ChatGPT / Codex CLI）は必ず本ファイルを最初に読み、
以下の構造を厳密に解釈すること。

- **CANONICAL SPEC**：現在有効な憲法（最優先）
- **CURRENT STATE**：いま何が実装済みか／次に何をするか
- **DECISION LOG**：過去の判断ログ（消さない・巻き戻さない）

---

# CANONICAL SPEC（現在有効な仕様・憲法）

## 基本方針
- **PvPvE（プレイヤー同士の攻撃が可能）**
  - PvE（敵）も存在し、同一フィールド内で混在する
- **同時接続100人以上を前提に設計**
- 参考構造：**Realm of the Mad God Exalt 型**
  - 同一ワールドに多数のプレイヤーが存在
  - 高負荷戦闘は小規模インスタンスに分離
- プラットフォーム：**Web（PWA想定）**
- 世界観：**学園バトル**

---

## 戦闘の核：Survivor Battle Area
- 人数：**最大50人（PvPvE）**
- セッション時間：**5〜10分**
- 操作：**移動 + 攻撃（手動）**
- 敵：**大量スポーン**
- 難易度：**時間経過で上昇**
- 成長：**経験値（XP）でレベルアップし、ステータスポイント（+5）を自由に割り振る**
- 当たり判定：**2D**
- 処理：**サーバ権威（authoritative）**
- Tick：**15〜20/s**

※ 初期フェーズでは「最小戦闘ループ（敵・プレイヤー双方にダメージが成立する）」の成立を最優先とする。

---

## 戦闘仕様（COMBAT）
- 攻撃は **手動発動**
- 攻撃は **射撃型（波動拳風）**
- 攻撃エフェクトは **クライアント側で表示**
  - 画像：`images/effect/nomarl_attack_0.png`（右端＝頭／左端＝尾）
  - 尾（左端）は発射起点に固定し、方向へ回転させる
- ダメージ判定・死亡判定は **サーバ側で確定**
- 攻撃にはクールダウン（レート制限）が存在する
- 対象：
  - 敵（PvE）
  - プレイヤー（PvP）
- 敵：
  - HPを持ち、ダメージで減少する
  - HPが0になると消滅（撃破）
- プレイヤー：
  - HPを持ち、ダメージで減少する
  - HPが0になると死亡状態になり、一定後に復帰する
- 攻撃にはクリティカルヒットの概念が存在する
- クリティカル判定はサーバ側で行う
- 運（Luck）ステータスがクリティカル発生率に影響する
- クリティカル発生時は与ダメージが増加し、視覚的に判別できる演出を表示する

---

### PvP / PvPvE 補足仕様（確定）

- プレイヤーの攻撃は、敵（PvE）だけでなく **他プレイヤー（PvP）にも命中する**
- PvP においてもダメージ計算・HP減少・死亡判定は **サーバ権威**で確定する
- 自分自身への攻撃命中は発生しない（自爆禁止）
- 攻撃クールダウンは PvE / PvP 共通ロジックで管理する
- Friendly Fire（プレイヤー同士の攻撃可否）は **サーバ側定数で制御可能**とする

#### PvP 撃破時の経験値（XP）
- プレイヤーを撃破した場合、**倒されたプレイヤーが保持していた XP の 1/2 を取得**する
- XP 付与・最終値確定はサーバ権威で行う

#### PvP 接触ダメージ
- プレイヤー同士が接触した場合、**双方に小ダメージ**を与える
- 接触ダメージ時には被弾演出を表示する
- 接触ダメージもクールダウン制御の対象とする

---

## 成長（LEVEL / STATS）
- 敵またはプレイヤーを倒すと経験値（XP）を獲得する（サーバ確定）
- XPが閾値に達するとレベルアップする
- レベルアップ時、ステータスポイント（SPT）を **+5** 付与する
- SPTは以下に自由に割り振れる：
  - HP
  - SP
  - 攻撃
  - 防御
  - 運
  - 移動速度
  - 攻撃速度
- XP / レベル / SPT / 最終ステータスは **サーバ権威**で確定する

---

## 入力方式（INPUT）

### 移動入力（統一）
- 操作入力は共通の **MoveInput（x, y: -1.0〜1.0）** に統一
- クライアント側で各入力方式を MoveInput に変換しサーバへ送信
- サーバは MoveInput のみを信頼して処理（入力方式非依存）

#### 対応入力
- **PC**
  - WASD / 矢印キー
- **モバイル（スマホ／タブレット）**
  - 仮想スティック（左下・移動のみ）

---

### 攻撃入力（確定仕様）
- **PC**
  - 攻撃：左クリック / 長押し
  - 攻撃方向：マウスカーソルの位置
- **モバイル（スマホ／タブレット）**
  - 攻撃：ワールド領域のタップ / 長押し
    - タップ：単発
    - 長押し：押下中連続攻撃
  - 攻撃方向：タップ／長押しした位置
- UI領域への入力は攻撃として扱わない
- 攻撃方向の最終判定・正規化・連射間隔は **サーバ権威**

---

## カメラ / マップ
- カメラは **主人公中心に追従**
- UIは **カメラ非追従（画面固定）**
- 背景：
  - `map/school2.png` を使用
  - 表示スケール：**4倍**
  - マップ端まで移動可能（サーバ側クランプ対応）

---

## UI / HUD 方針

### PC HUD
- 画面左右・下に白背景の固定UI領域を配置
  - 左：HP / SP ゲージ + 操作ガイド + GOLD
  - 右：インベントリ
  - 下：アイテムスロット（5） / スキルスロット（3）

### モバイル HUD（仕様更新）
- PCの「左パネル」に表示されている情報（HP/SP/ガイド/GOLD等）は、
  **マップ上に重なるオーバーレイUIとして常設表示**する（画面固定・カメラ非追従）
- 常設UI（モバイル）：
  - HP / SP ゲージ（小さめ）
  - 小さな数値（現在/最大）
  - （必要なら）GOLD
  - 左下：移動スティック
- 操作説明（ガイド）は、PCのようなサイドパネルではなく
  **マップ上の上部オーバーレイ**として簡潔に表示する（情報量は最小）
- **キャラクターボタン（ステータス/キャラ画面を開く導線）は常設しない**
  - 右上の折りたたみボタン（FAB/ドロワー）内に格納する
- 追加機能は右上の折りたたみボタン（FAB/ドロワー）から呼び出す

### HP / SP 表示
- ゲージ表示を基本とする
- 数値（現在値 / 最大値）を小さく併記
- PC / モバイル共通仕様


### オプション画面（確定仕様）
- **ESCキー**でオプション画面を表示／非表示
- オプション画面は **画面固定UI（カメラ非追従）**
- UI操作は攻撃入力として扱わない（誤爆防止）
- キャラクター画面と同じトグル原理で管理する


### BGM
- エリアBGMを常時ループ再生する
- 初期音量は **50%**
- 音量はオプション画面から調整可能
- 再生制御・音量反映はクライアント側で行う


---

## 表示・演出
- 主人公：
  - Rect 表示を廃止
  - 連番 PNG スプライトによるアニメーション表示
  - ファイル番号順で再生
  - サイズ：**40x40**
  - 再生FPSは定数で管理
- 敵：
  - 頭上に簡易HPテキストを表示

---

## ネットワーク
- クライアント：
  - WebSocket 接続
  - ホスト名は自動判定
  - 失敗時は localhost にフォールバック
- サーバ：
  - `0.0.0.0` で待受

---

## AI運用ルール
- ChatGPT：設計・判断・Codex用プロンプト生成
- Codex CLI：リポジトリを直接編集して実装
- 人間：最終判断、commit / push のみ実行
- **不要な新規ファイル乱立は禁止**
- **既存コードは信用しないが削除しない**
- 迷ったら **最もシンプルな実装**を選ぶ

---

## 技術スタック（確定・最優先）

### クライアント
- 言語：**TypeScript**
- フレームワーク：**Phaser（2D）**
- 描画・当たり判定・入力はクライアント側で実装
- 2Dロジック前提（3Dは使用しない）

### マルチプレイ / ルーム管理
- **Colyseus**
  - WebSocket 通信
  - ルームベース
  - Survivor Battle Area は Colyseus Room として実装する

### サーバ
- **Node.js + TypeScript**
- フレームワーク：**Fastify または NestJS**
- Colyseus Server を内包
- ゲーム進行・同期・検証はサーバ権威（authoritative）

### データベース
- **PostgreSQL**
- ORM：**Prisma**

### 認証
- **Discord OAuth2**
- Discord User ID を主キーとして扱う

### リアルタイム補助
- **Redis**
  - ルーム一覧キャッシュ
  - レート制限
  - ランキング・一時データ用

### ホスティング / インフラ
- フロントエンド：**Cloudflare**
- サーバ：**Docker**

---

<!-- AUTO:CURRENT_STATE:BEGIN -->
# CURRENT STATE（いまの作業位置）

- ブランチ：reboot
- フェーズ：
  - 土台構築（完了）
  - 入力統一（完了）
  - 最小戦闘ループ（PvE / PvP）（完了）
  - Phase 3：ステータス体感反映（完了）
  - UIギャップ解消＋キャラ画面プロフィール枠アニメ（完了）
  - 演出：死亡爆発（PNG連番）（完了）
  - 敵AI：追尾＋接触ダメージ（完了）

- 到達点：
  - TypeScript + Phaser（client）起動（Vite）
  - TypeScript + Colyseus（server）起動（Fastify + ws-transport）
  - client ↔ server 接続
  - サーバtick稼働（15/s）
  - 敵スポーン（仮：1.5s間隔）
  - MoveInput（x,y:-1..1）へ入力を統一
    - PC：WASD / 矢印
    - モバイル：左下仮想スティック

  - 攻撃入力の統一
    - PC：左クリック / 長押し（方向＝マウスカーソル）
    - モバイル：ワールド領域タップ / 長押し（方向＝タップ位置）
    - UI領域への入力は攻撃として扱わない（誤爆防止）

  - 手動攻撃の成立（射撃型・波動拳風）
  - サーバ権威ダメージ判定（PvE / PvP）
    - 敵へのダメージ → HP0で消滅
    - プレイヤーへのダメージ → HP0で死亡 → 一定後復帰

  - PvP成立
    - 他プレイヤーへの命中・HP減少・死亡→復帰
    - 自爆禁止
    - クールダウンは PvE / PvP 共通
    - Friendly Fire はサーバ定数で制御
  - PvP撃破XP
    - 撃破した相手が保持していた XP の 1/2 を取得
  - PvP接触ダメージ
    - プレイヤー同士の接触で双方に小ダメージ＋被弾演出（防御軽減も適用）

  - クリティカルヒット（運依存・サーバ判定）
  - ダメージ表示
    - 与ダメージ / 被ダメージで色分け
    - クリティカルは強調表示
    - 被弾時に赤パルス演出

  - 攻撃エフェクト同期
    - 他プレイヤーの攻撃エフェクトをサーバ起点で可視化
    - 自分の攻撃は二重表示しない
    - 画像：`images/effect/nomarl_attack_0.png`（尾が発射起点）

  - カメラ追従（主人公中心）＋背景スクロール
  - UIはカメラ非追従（画面固定）
  - 背景
    - map/school2.png を使用
    - 表示スケール：4倍
    - マップ端まで移動可能（サーバ側クランプ）

  - 主人公表示
    - Rect 表示を廃止
    - 連番 PNG スプライトアニメーションに差し替え
    - 番号順再生、サイズ 40x40

  - HP / SP 表示
    - ゲージ＋小さな数値（current / max）
    - PC / モバイル共通
    - SP 表示を sp / maxSp に統一

  - HUD 分岐
    - PC：左右・下の固定パネル
      - 左パネルに「操作ガイド」表示を復帰
      - GOLD 表示（現状は GOLD: 0 の静的表示）
    - モバイル：最小HUD＋マップ上オーバーレイ＋FAB
      - 上部オーバーレイに簡潔な操作ガイド＋GOLD表示を追加（現状は GOLD: 0 の静的表示）
      - ガイド/GOLD/UIは攻撃除外対象に含め、UI操作が攻撃に化けない

  - モバイル画面対応
    - RESIZE で画面サイズに追従
    - 画面回転時に UI を再生成して崩れを抑制（完全解消は今後課題）

  - ネットワーク
    - WebSocket 接続
    - ホスト名自動判定（失敗時 localhost フォールバック）
    - サーバは 0.0.0.0 で待受

  - Phase 3：ステータス体感反映（サーバ権威）
    - MOVE：実移動速度に反映（倍率＋上限）
    - ATK SPD：攻撃クールダウン（連射間隔）に反映（下限キャップ）
      - 初期が速すぎて体感が弱かったため、初期クールダウンを遅くして差が見えるように調整
    - ATK / DEF：ダメージ計算に反映（最低ダメージfloorあり）
    - LUCK：クリティカル率に反映（上限キャップあり）
    - PvE / PvP 共通ロジックで適用

  - キャラクター画面（UI）
    - PC / モバイルで導線分岐（PC：パネル導線、モバイル：FAB内導線）
    - 証明写真枠にプロフィール画像アニメを表示
      - images/mobtaro_profilesprite/mobtaro_profiles_{1..4}.png
      - 番号順でループ再生、キャラ画面を開く度に開始フレームをランダム化
      - 枠内マスクでクロップ（枠外は表示しない）
      - 画像比率は維持（単一倍率スケール）
      - 白い余白が出ないように上下を覆う範囲でY位置をクランプ
    - Lv / XP / SPT 表示は証明写真枠の下に配置して重なりを回避

  - 演出：死亡爆発（クライアント表示）
    - PNG連番（images/bomb/frame_00_delay-0.1s.png〜frame_34_delay-0.1s.png）を読み込み
    - 死亡判定（isDead の false→true 遷移）をトリガに、その場で爆発アニメを1回再生
    - 自分/他プレイヤー共通で再生（同一死亡での二重再生は防止）
    - 同時再生数に上限を設け、超過時は古い爆発を破棄
    - 再生終了後は必ず destroy（リーク防止）
    - 爆発中は対象キャラを一時非表示/フェードで最小対応

  - 敵AI：追尾＋接触ダメージ（サーバ権威）
    - サーバtickで各敵が「最寄りの生存プレイヤー」を探索して追尾移動（ENEMY_MOVE_SPEED、マップクランプ適用）
    - 敵×プレイヤー接触でダメージ（ENEMY_CONTACT_RADIUS、ENEMY_CONTACT_COOLDOWN_MS）
    - 死亡中プレイヤーはターゲット対象外
    - 既存の敵スポーン/HP/撃破/描画は維持

  - オプション画面（ESCトグル）＋BGM再生（完了）
  - オプション画面（UI）
    - ESCキーで表示／非表示をトグル
    - キャラクター画面と同一の管理方式
    - UI操作は攻撃除外対象

  - BGM
    - schoolエリアBGMをループ再生
      - audio/school/Pixel Playground Afternoon.wav
    - 初期音量：50%
    - オプション画面から音量調整可能


- ローカル起動：
  - npm install
  - npm run dev
  - http://localhost:5173
  - （任意）http://localhost:2567/health

- 既知の課題：
  - GOLD は現状静的表示（GOLD: 0）。実データ接続・増減ロジックは未実装
  - 背景画像サイズ変更時のクランプ範囲・カメラ境界・描画整合の最終確認
  - モバイル画面回転時のUI再生成は暫定対応（完全安定化は未）
  - 端末判定（スマホ / タブレット / PC）が UA 依存でブレる可能性

- 次の目標（直近）：
  - ステータス反映のバランス調整（TUNING値の微調整のみで回す）
    - 初期攻撃速度 / 伸び幅 / 下限値の体感確認
    - MOVE/ATK/DEF/LUCK も同様に「体感が出るが壊れない」範囲へ
  - UI表示の文言・レイアウト微調整（特にモバイル上部の詰まり）
  - プロフィール枠の「顔位置」微調整（必要ならYオフセット定数で）
  - 敵AIの体感調整（定数のみ）
    - ENEMY_MOVE_SPEED / ENEMY_CONTACT_COOLDOWN_MS / ENEMY_CONTACT_RADIUS の調整

- 次の目標（中期）：
  - state 同期を描画に完全統一（player / enemy を state 駆動）
  - Survivor Battle Area の進行フロー整理
  - LvUP → 強化選択 → 効果適用の体験設計調整
<!-- AUTO:CURRENT_STATE:END -->

---

# DECISION LOG（過去の判断・消さない）

## 2026-01-13
- PvPvE 案を廃止し、**PvE オンリー**に決定（当時）
- 同時接続100人は「同一ワールド＋分離インスタンス」で実現
- Copilot は使用せず、**ChatGPT + Codex CLI** に統一
- README.md を **AI 指示の唯一の正本**とする

## 2026-01-14
- 仕様を PvEオンリー から **PvPvE** に更新（プレイヤー同士の攻撃を許可）
- モバイルUIは「左パネル相当をマップ上オーバーレイ常設」、キャラクターボタンはFAB内に格納する
