# AI INSTRUCTIONS / SOURCE OF TRUTH

この README.md は本プロジェクトにおける **唯一の正本**。
AI（ChatGPT / Codex CLI）は必ず本ファイルを最初に読み、
以下の構造を厳密に解釈すること。

- **CANONICAL SPEC**：現在有効な憲法（最優先）
- **CURRENT STATE**：いま何が実装済みか／次に何をするか
- **DECISION LOG**：過去の判断ログ（消さない・巻き戻さない）

---

# CANONICAL SPEC（現在有効な仕様・憲法）

## 基本方針
- **PvPvE（プレイヤー同士の攻撃が可能）**
  - PvE（敵）も存在し、同一フィールド内で混在する
- **同時接続100人以上を前提に設計**
- 参考構造：**Realm of the Mad God Exalt 型**
  - 同一ワールドに多数のプレイヤーが存在
  - 高負荷戦闘は小規模インスタンスに分離
- プラットフォーム：**Web（PWA想定）**
- 世界観：**学園バトル**

---

## 戦闘の核：Survivor Battle Area
- 人数：**最大50人（PvPvE）**
- セッション時間：**5〜10分**
- 操作：**移動 + 攻撃（手動）**
- 敵：**大量スポーン**
- 難易度：**時間経過で上昇**
- 成長：**経験値（XP）でレベルアップし、ステータスポイント（+5）を自由に割り振る**
- 当たり判定：**2D**
- 処理：**サーバ権威（authoritative）**
- Tick：**15〜20/s**

※ 初期フェーズでは「最小戦闘ループ（敵・プレイヤー双方にダメージが成立する）」の成立を最優先とする。

---

## 戦闘仕様（COMBAT）
- 攻撃は **手動発動**
- 攻撃は **射撃型（波動拳風）**
- 攻撃エフェクトは **クライアント側で表示**
- ダメージ判定・死亡判定は **サーバ側で確定**
- 攻撃にはクールダウン（レート制限）が存在する
- 対象：
  - 敵（PvE）
  - プレイヤー（PvP）
- 敵：
  - HPを持ち、ダメージで減少する
  - HPが0になると消滅（撃破）
- プレイヤー：
  - HPを持ち、ダメージで減少する
  - HPが0になると死亡状態になり、一定後に復帰する
- 攻撃にはクリティカルヒットの概念が存在する
- クリティカル判定はサーバ側で行う
- 運（Luck）ステータスがクリティカル発生率に影響する
- クリティカル発生時は与ダメージが増加し、視覚的に判別できる演出を表示する

---

## 成長（LEVEL / STATS）
- 敵またはプレイヤーを倒すと経験値（XP）を獲得する（サーバ確定）
- XPが閾値に達するとレベルアップする
- レベルアップ時、ステータスポイント（SPT）を **+5** 付与する
- SPTは以下に自由に割り振れる：
  - HP
  - SP
  - 攻撃
  - 防御
  - 運
  - 移動速度
  - 攻撃速度
- XP / レベル / SPT / 最終ステータスは **サーバ権威**で確定する

---

## 入力方式（INPUT）

### 移動入力（統一）
- 操作入力は共通の **MoveInput（x, y: -1.0〜1.0）** に統一
- クライアント側で各入力方式を MoveInput に変換しサーバへ送信
- サーバは MoveInput のみを信頼して処理（入力方式非依存）

#### 対応入力
- **PC**
  - WASD / 矢印キー
- **モバイル（スマホ／タブレット）**
  - 仮想スティック（左下・移動のみ）

---

### 攻撃入力（確定仕様）
- **PC**
  - 攻撃：左クリック / 長押し
  - 攻撃方向：マウスカーソルの位置
- **モバイル（スマホ／タブレット）**
  - 攻撃：ワールド領域のタップ / 長押し
    - タップ：単発
    - 長押し：押下中連続攻撃
  - 攻撃方向：タップ／長押しした位置
- UI領域への入力は攻撃として扱わない
- 攻撃方向の最終判定・正規化・連射間隔は **サーバ権威**

---

## カメラ / マップ
- カメラは **主人公中心に追従**
- UIは **カメラ非追従（画面固定）**
- 背景：
  - `map/school2.png` を使用
  - 表示スケール：**4倍**
  - マップ端まで移動可能（サーバ側クランプ対応）

---

## UI / HUD 方針

### PC HUD
- 画面左右・下に白背景の固定UI領域を配置
  - 左：HP / SP ゲージ + 操作ガイド + GOLD
  - 右：インベントリ
  - 下：アイテムスロット（5） / スキルスロット（3）

### モバイル HUD（仕様更新）
- PCの「左パネル」に表示されている情報（HP/SP/ガイド/GOLD等）は、
  **マップ上に重なるオーバーレイUIとして常設表示**する（画面固定・カメラ非追従）
- 常設UI（モバイル）：
  - HP / SP ゲージ（小さめ）
  - 小さな数値（現在/最大）
  - （必要なら）GOLD
  - 左下：移動スティック
- 操作説明（ガイド）は、PCのようなサイドパネルではなく
  **マップ上の上部オーバーレイ**として簡潔に表示する（情報量は最小）
- **キャラクターボタン（ステータス/キャラ画面を開く導線）は常設しない**
  - 右上の折りたたみボタン（FAB/ドロワー）内に格納する
- 追加機能は右上の折りたたみボタン（FAB/ドロワー）から呼び出す

### HP / SP 表示
- ゲージ表示を基本とする
- 数値（現在値 / 最大値）を小さく併記
- PC / モバイル共通仕様

---

## 表示・演出
- 主人公：
  - Rect 表示を廃止
  - 連番 PNG スプライトによるアニメーション表示
  - ファイル番号順で再生
  - サイズ：**40x40**
  - 再生FPSは定数で管理
- 敵：
  - 頭上に簡易HPテキストを表示

---

## ネットワーク
- クライアント：
  - WebSocket 接続
  - ホスト名は自動判定
  - 失敗時は localhost にフォールバック
- サーバ：
  - `0.0.0.0` で待受

---

## AI運用ルール
- ChatGPT：設計・判断・Codex用プロンプト生成
- Codex CLI：リポジトリを直接編集して実装
- 人間：最終判断、commit / push のみ実行
- **不要な新規ファイル乱立は禁止**
- **既存コードは信用しないが削除しない**
- 迷ったら **最もシンプルな実装**を選ぶ

---

## 技術スタック（確定・最優先）

### クライアント
- 言語：**TypeScript**
- フレームワーク：**Phaser（2D）**
- 描画・当たり判定・入力はクライアント側で実装
- 2Dロジック前提（3Dは使用しない）

### マルチプレイ / ルーム管理
- **Colyseus**
  - WebSocket 通信
  - ルームベース
  - Survivor Battle Area は Colyseus Room として実装する

### サーバ
- **Node.js + TypeScript**
- フレームワーク：**Fastify または NestJS**
- Colyseus Server を内包
- ゲーム進行・同期・検証はサーバ権威（authoritative）

### データベース
- **PostgreSQL**
- ORM：**Prisma**

### 認証
- **Discord OAuth2**
- Discord User ID を主キーとして扱う

### リアルタイム補助
- **Redis**
  - ルーム一覧キャッシュ
  - レート制限
  - ランキング・一時データ用

### ホスティング / インフラ
- フロントエンド：**Cloudflare**
- サーバ：**Docker**

---

<!-- AUTO:CURRENT_STATE:BEGIN -->
# CURRENT STATE（いまの作業位置）

- 実装済み：
  - 入力統一（MoveInput）
  - 手動攻撃＋ダメージ／死亡処理（PvE中心）
  - XP / Lv / SPT
  - 主人公スプライトアニメ表示
  - PC / モバイル HUD 分岐
- 次の作業：
  - PvPダメージ適用（プレイヤー同士の被弾・死亡の成立）
  - ステータス割り振り画面のUX改善（モバイルはFAB内のキャラクターボタンから開く）
  - UI（FAB含む）の整理
  - 視認性・演出調整

<!-- AUTO:CURRENT_STATE:END -->

---

# DECISION LOG（過去の判断・消さない）

## 2026-01-13
- PvPvE 案を廃止し、**PvE オンリー**に決定（当時）
- 同時接続100人は「同一ワールド＋分離インスタンス」で実現
- Copilot は使用せず、**ChatGPT + Codex CLI** に統一
- README.md を **AI 指示の唯一の正本**とする

## 2026-01-14
- 仕様を PvEオンリー から **PvPvE** に更新（プレイヤー同士の攻撃を許可）
- モバイルUIは「左パネル相当をマップ上オーバーレイ常設」、キャラクターボタンはFAB内に格納する
