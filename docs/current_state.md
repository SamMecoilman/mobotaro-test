# CURRENT STATE（いまの作業位置）

- ブランチ：reboot
- フェーズ：
  - 土台構築（完了）
  - 入力統一（完了）
  - 最小戦闘ループ（PvE / PvP）（完了）
  - Phase 3：ステータス体感反映（完了）
  - UIギャップ解消＋キャラ画面プロフィール枠アニメ（完了）
  - 演出：死亡爆発（PNG連番）（完了）
  - 敵AI：追尾＋接触ダメージ（完了）

- 到達点：
  - TypeScript + Phaser（client）起動（Vite）
  - TypeScript + Colyseus（server）起動（Fastify + ws-transport）
  - client ↔ server 接続
  - サーバtick稼働（15/s）
  - 敵スポーン（仮：1.5s間隔）
  - MoveInput（x,y:-1..1）へ入力を統一
    - PC：WASD / 矢印
    - モバイル：左下仮想スティック

  - 攻撃入力の統一
    - PC：左クリック / 長押し（方向＝マウスカーソル）
    - モバイル：ワールド領域タップ / 長押し（方向＝タップ位置）
    - UI領域への入力は攻撃として扱わない（誤爆防止）

  - 手動攻撃の成立（射撃型・波動拳風）
  - サーバ権威ダメージ判定（PvE / PvP）
    - 敵へのダメージ → HP0で消滅
    - プレイヤーへのダメージ → HP0で死亡 → 一定後復帰

  - PvP成立
    - 他プレイヤーへの命中・HP減少・死亡→復帰
    - 自爆禁止
    - クールダウンは PvE / PvP 共通
    - Friendly Fire はサーバ定数で制御
  - PvP撃破XP
    - 撃破した相手が保持していた XP の 1/2 を取得
  - PvP接触ダメージ
    - プレイヤー同士の接触で双方に小ダメージ＋被弾演出（防御軽減も適用）

  - クリティカルヒット（運依存・サーバ判定）
  - ダメージ表示
    - 与ダメージ / 被ダメージで色分け
    - クリティカルは強調表示
    - 被弾時に赤パルス演出

  - 攻撃エフェクト同期
    - 他プレイヤーの攻撃エフェクトをサーバ起点で可視化
    - 自分の攻撃は二重表示しない

  - カメラ追従（主人公中心）＋背景スクロール
  - UIはカメラ非追従（画面固定）
  - 背景
    - map/school2.png を使用
    - 表示スケール：4倍
    - マップ端まで移動可能（サーバ側クランプ）

  - 主人公表示
    - Rect 表示を廃止
    - 連番 PNG スプライトアニメーションに差し替え
    - 番号順再生、サイズ 40x40

  - HP / SP 表示
    - ゲージ＋小さな数値（current / max）
    - PC / モバイル共通
    - SP 表示を sp / maxSp に統一

  - HUD 分岐
    - PC：左右・下の固定パネル
      - 左パネルに「操作ガイド」表示を復帰
      - GOLD 表示（現状は GOLD: 0 の静的表示）
    - モバイル：最小HUD＋マップ上オーバーレイ＋FAB
      - 上部オーバーレイに簡潔な操作ガイド＋GOLD表示を追加（現状は GOLD: 0 の静的表示）
      - ガイド/GOLD/UIは攻撃除外対象に含め、UI操作が攻撃に化けない

  - モバイル画面対応
    - RESIZE で画面サイズに追従
    - 画面回転時に UI を再生成して崩れを抑制（完全解消は今後課題）

  - ネットワーク
    - WebSocket 接続
    - ホスト名自動判定（失敗時 localhost フォールバック）
    - サーバは 0.0.0.0 で待受

  - Phase 3：ステータス体感反映（サーバ権威）
    - MOVE：実移動速度に反映（倍率＋上限）
    - ATK SPD：攻撃クールダウン（連射間隔）に反映（下限キャップ）
      - 初期が速すぎて体感が弱かったため、初期クールダウンを遅くして差が見えるように調整
    - ATK / DEF：ダメージ計算に反映（最低ダメージfloorあり）
    - LUCK：クリティカル率に反映（上限キャップあり）
    - PvE / PvP 共通ロジックで適用

  - キャラクター画面（UI）
    - PC / モバイルで導線分岐（PC：パネル導線、モバイル：FAB内導線）
    - 証明写真枠にプロフィール画像アニメを表示
      - images/mobtaro_profilesprite/mobtaro_profiles_{1..4}.png
      - 番号順でループ再生、キャラ画面を開く度に開始フレームをランダム化
      - 枠内マスクでクロップ（枠外は表示しない）
      - 画像比率は維持（単一倍率スケール）
      - 白い余白が出ないように上下を覆う範囲でY位置をクランプ
    - Lv / XP / SPT 表示は証明写真枠の下に配置して重なりを回避

  - 演出：死亡爆発（クライアント表示）
    - PNG連番（images/bomb/frame_00_delay-0.1s.png〜frame_34_delay-0.1s.png）を読み込み
    - 死亡判定（isDead の false→true 遷移）をトリガに、その場で爆発アニメを1回再生
    - 自分/他プレイヤー共通で再生（同一死亡での二重再生は防止）
    - 同時再生数に上限を設け、超過時は古い爆発を破棄
    - 再生終了後は必ず destroy（リーク防止）
    - 爆発中は対象キャラを一時非表示/フェードで最小対応

  - 敵AI：追尾＋接触ダメージ（サーバ権威）
    - サーバtickで各敵が「最寄りの生存プレイヤー」を探索して追尾移動（ENEMY_MOVE_SPEED、マップクランプ適用）
    - 敵×プレイヤー接触でダメージ（ENEMY_CONTACT_RADIUS、ENEMY_CONTACT_COOLDOWN_MS）
    - 死亡中プレイヤーはターゲット対象外
    - 既存の敵スポーン/HP/撃破/描画は維持

  - オプション画面（ESCトグル）＋BGM再生（完了）
  - オプション画面（UI）
    - ESCキーで表示／非表示をトグル
    - キャラクター画面と同一の管理方式
    - UI操作は攻撃除外対象

  - BGM
    - schoolエリアBGMをループ再生
      - audio/school/Pixel Playground Afternoon.wav
    - 初期音量：50%
    - オプション画面から音量調整可能


- ローカル起動：
  - npm install
  - npm run dev
  - http://localhost:5173
  - （任意）http://localhost:2567/health

- 既知の課題：
  - GOLD は現状静的表示（GOLD: 0）。実データ接続・増減ロジックは未実装
  - 背景画像サイズ変更時のクランプ範囲・カメラ境界・描画整合の最終確認
  - モバイル画面回転時のUI再生成は暫定対応（完全安定化は未）
  - 端末判定（スマホ / タブレット / PC）が UA 依存でブレる可能性

- 次の目標（直近）：
  - ステータス反映のバランス調整（TUNING値の微調整のみで回す）
    - 初期攻撃速度 / 伸び幅 / 下限値の体感確認
    - MOVE/ATK/DEF/LUCK も同様に「体感が出るが壊れない」範囲へ
  - UI表示の文言・レイアウト微調整（特にモバイル上部の詰まり）
  - プロフィール枠の「顔位置」微調整（必要ならYオフセット定数で）
  - 敵AIの体感調整（定数のみ）
    - ENEMY_MOVE_SPEED / ENEMY_CONTACT_COOLDOWN_MS / ENEMY_CONTACT_RADIUS の調整

- 次の目標（中期）：
  - state 同期を描画に完全統一（player / enemy を state 駆動）
  - Survivor Battle Area の進行フロー整理
  - LvUP → 強化選択 → 効果適用の体験設計調整
